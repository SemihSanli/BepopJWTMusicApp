@using BepopJWT.Consume.SongDTOs
@model List<ResultSongWithArtists>

@{
    // Token null gelirse boş string ata ki JS hatası almayalım
    var userToken = Context.User.FindFirst("AccessToken")?.Value ?? "";
    var recommendedSongs = ViewBag.RecommendedSongs as List<ResultSongWithArtists>;
}

<input type="hidden" id="AccessToken" value="@userToken" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    :root {
        --primary-color: #8b5cf6;
        --secondary-color: #d946ef;
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.12);
        --bg-dark: #0f0f13;
        --text-light: #f5f5f7;
        --text-muted: #a1a1aa;
        --hover-glow: rgba(139, 92, 246, 0.2);
    }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-dark);
        color: var(--text-light);
        padding-bottom: 100px; /* Player için alt boşluk */
    }

    .container-fluid {
        max-width: 1300px;
        margin: auto;
    }

    /* --- Hero Section --- */
    .hero-section {
        position: relative;
        padding: 100px 20px 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: url('/Bebop/assets/img/b9.jpg') no-repeat center/cover;
        border-radius: 32px;
        margin-bottom: 60px;
        overflow: hidden;
    }

    .hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(4px);
        z-index: 1;
    }

    .hero-content {
        position: relative;
        z-index: 2;
        max-width: 600px;
    }

        .hero-content h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(90deg, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .hero-content p {
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-bottom: 30px;
        }

    .hero-btn {
        padding: 16px 40px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        transition: transform 0.3s;
    }

        .hero-btn:hover {
            transform: scale(1.05);
        }

    /* --- Music Card Grid --- */
    .music-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 24px;
        margin-bottom: 60px;
    }

    .music-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        transition: all 0.4s ease;
    }

        .music-card:hover {
            transform: translateY(-8px);
            border-color: var(--hover-glow);
            box-shadow: 0 12px 24px var(--hover-glow);
        }

        .music-card img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .music-card:hover img {
            transform: scale(1.1);
        }

    .music-card-body {
        padding: 16px;
    }

        .music-card-body h6 {
            font-weight: 700;
            font-size: 1rem;
            margin: 0 0 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-card-body p {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin: 0;
        }

    .floating-play {
        position: absolute;
        bottom: 12px;
        right: 12px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        box-shadow: 0 6px 20px var(--hover-glow);
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        z-index: 5;
    }

    .music-card:hover .floating-play {
        opacity: 1;
        transform: translateY(0);
    }

    /* --- Track List --- */
    .track-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .track-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-radius: 16px;
        transition: background 0.3s;
        cursor: pointer;
    }

        .track-item:hover {
            background: rgba(255,255,255,0.06);
        }

        .track-item img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 12px;
            margin-right: 16px;
        }

    .track-rank {
        width: 30px;
        font-weight: 600;
        color: var(--text-muted);
    }

    .ai-badge {
        background: rgba(139, 92, 246, 0.1);
        color: #a855f7;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: bold;
        margin-bottom: 6px;
        display: inline-block;
    }

    /* --- Event Card --- */
    .event-card {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 32px;
        padding: 24px;
        color: #fff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 240px;
    }

        .event-card h4 {
            font-weight: 800;
            margin-bottom: 8px;
        }

        .event-card p {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.85);
            margin-bottom: 16px;
        }

        .event-card .btn {
            border-radius: 16px;
            padding: 10px;
            font-weight: 700;
        }

    /* --- Fixed Audio Player --- */
    .fixed-player-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(15, 15, 19, 0.95);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--glass-border);
        padding: 15px 20px;
        z-index: 1000;
        display: none; /* Başlangıçta gizli */
        align-items: center;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    }

    .player-content {
        max-width: 1300px;
        margin: auto;
        display: flex;
        align-items: center;
        width: 100%;
        gap: 20px;
    }

    .now-playing-info {
        display: flex;
        align-items: center;
        width: 250px;
    }

    .now-playing-img {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        object-fit: cover;
        margin-right: 15px;
    }

    .audio-wrapper {
        flex-grow: 1;
    }

    /* Varsayılan audio player stilini biraz daha karanlık temaya uydurmak zor olsa da width:100% veriyoruz */
    audio {
        width: 100%;
        height: 40px;
        border-radius: 20px;
    }
</style>

<div class="container-fluid">

    @* --- Hero Section --- *@
    <div class="hero-section">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1>Sesin Geleceğini Keşfet</h1>
            <p>Zevkine göre şekillenen algoritma ile sınırsız müzik deneyimi burada başlar.</p>
            <button class="hero-btn">Hemen Dinle</button>
        </div>
    </div>

    @* --- Trendler --- *@
    <h2 class="fw-bold mb-3">Trendler</h2>
    <div class="music-grid">
        @if (Model != null)
        {
            foreach (var item in Model.Take(6))
            {
                <div class="music-card" onclick="checkSongAccess(event, @item.SongId, '@item.FileUrl', '@item.SongTitle', '@item.ImageUrl', '@item.Name')">
                    <img src="@item.ImageUrl" alt="@item.SongTitle" />
                    <div class="music-card-body">
                        <h6>@item.SongTitle</h6>
                        <p>@item.Name</p>
                    </div>
                    <div class="floating-play"><i class="fa fa-play text-white"></i></div>
                </div>
            }
        }
    </div>

    @* --- Önerilen Şarkılar --- *@
    <h2 class="fw-bold mb-3 mt-5">Senin İçin Özelleştirildi ✨</h2>
    <div class="music-grid">
        @if (recommendedSongs != null && recommendedSongs.Any())
        {
            foreach (var item in recommendedSongs.Take(6))
            {
                <div class="music-card" onclick="checkSongAccess(event, @item.SongId, '@item.FileUrl', '@item.SongTitle', '@item.ImageUrl', '@item.Name')">
                    <img src="@item.ImageUrl" alt="@item.SongTitle" />
                    <div class="music-card-body">
                        <div class="ai-badge">AI Match @Random.Shared.Next(85, 99)%</div>
                        <h6>@item.SongTitle</h6>
                        <p>@item.Name</p>
                    </div>
                    <div class="floating-play"><i class="fa fa-play text-white"></i></div>
                </div>
            }
        }
    </div>

    @* --- Yeni Çıkanlar ve Etkinlik --- *@
    <div class="row mt-5">
        <div class="col-lg-8">
            <h3 class="fw-bold mb-4">Yeni Çıkanlar</h3>
            <div class="track-list">
                @if (Model != null)
                {
                    int rank = 1;
                    foreach (var item in Model.OrderByDescending(x => x.SongId).Take(5))
                    {
                        <div class="track-item" onclick="checkSongAccess(event, @item.SongId, '@item.FileUrl', '@item.SongTitle', '@item.ImageUrl', '@item.Name')">
                            <span class="track-rank">@rank</span>
                            <img src="@item.ImageUrl" />
                            <div class="flex-grow-1">
                                <div class="fw-bold">@item.SongTitle</div>
                                <div class="text-muted small">@item.Name</div>
                            </div>
                            <div class="text-muted small me-4">03:45</div>
                            <button class="btn btn-link text-white-50 p-0"><i class="fa-regular fa-heart"></i></button>
                        </div>
                        rank++;
                    }
                }
            </div>
        </div>

        <div class="col-lg-4">
            <h3 class="fw-bold mb-4">Sıradaki Etkinlik</h3>
            <div class="event-card">
                <span class="badge bg-white text-dark mb-2 align-self-start">Live Event</span>
                <h4>Spring Music Festival</h4>
                <p>İstanbul'un kalbinde unutulmaz bir geceye davetlisiniz.</p>
                <button class="btn btn-light fw-bold text-primary">Biletleri İncele</button>
            </div>
        </div>
    </div>

</div>

<div class="fixed-player-bar" id="musicPlayerBar">
    <div class="player-content">
        <div class="now-playing-info">
            <img src="" id="playerImage" class="now-playing-img" alt="Album Art">
            <div>
                <h6 id="playerTitle" class="mb-0 fw-bold text-white">Song Title</h6>
                <small id="playerArtist" class="text-muted">Artist</small>
            </div>
        </div>

        <div class="audio-wrapper">
            <audio id="globalAudioPlayer" controls autoplay>
                <source src="" type="audio/mpeg">
                Tarayıcınız audio elementini desteklemiyor.
            </audio>
        </div>

        <button class="btn btn-sm btn-link text-white" onclick="closePlayer()"><i class="fa fa-times"></i></button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Şarkı erişimini kontrol et ve çal
    function checkSongAccess(e, songId, songUrl, songTitle, imageUrl, artistName) {
        if(e) e.preventDefault();

        // 1. DÜZELTME: Token'ı hidden inputtan alıyoruz.
        var tokenInput = document.getElementById("AccessToken");
        var token = tokenInput ? tokenInput.value : null;

        if (!token) {
            Swal.fire({
                icon: 'error',
                title: 'Giriş Gerekli',
                text: 'Müzik dinlemek için lütfen giriş yapın.',
                background: '#1e1e2d',
                color: '#fff',
                confirmButtonColor: '#a855f7'
            });
            return;
        }

        // Fetch isteği
        fetch(`https://localhost:7209/api/Songs/check-access/${songId}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error("API Hatası");
            return response.json();
        })
        .then(data => {
            if (data.isSuccess) {
                // Başarılıysa player'ı hazırla ve çal
                playMusic(songUrl, songTitle, imageUrl, artistName);

                const Toast = Swal.mixin({
                    toast: true,
                    position: 'bottom-end',
                    showConfirmButton: false,
                    timer: 3000,
                    background: '#1e1e2d',
                    color: '#fff',
                    didOpen: (toast) => {
                        toast.style.marginBottom = '80px'; // Player'ın üstünde çıksın
                    }
                });
                Toast.fire({ icon: 'success', title: 'Çalıyor: ' + songTitle });
            } else {
                // Başarısız (Premium yok vs.)
                Swal.fire({
                    title: 'Premium Gerekli 💎',
                    text: data.message || 'Bu içeriğe erişmek için premium üye olmalısınız.',
                    background: '#1e1e2d',
                    color: '#fff',
                    showCancelButton: true,
                    confirmButtonText: 'Paketlere Git',
                    cancelButtonText: 'Kapat',
                    confirmButtonColor: '#a855f7'
                }).then((res) => {
                    if (res.isConfirmed) window.location.href = "/Packages/Index";
                });
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire({ icon: 'error', title: 'Hata', text: 'Bir sorun oluştu.', background: '#1e1e2d', color: '#fff' });
        });
    }

    // 2. DÜZELTME VE GELİŞTİRME: Player fonksiyonu
    function playMusic(url, title, img, artist) {
        var playerBar = document.getElementById("musicPlayerBar");
        var audio = document.getElementById("globalAudioPlayer");

        // Player UI güncelleme
        document.getElementById("playerTitle").innerText = title;
        document.getElementById("playerImage").src = img;
        document.getElementById("playerArtist").innerText = artist;

        // Player Bar'ı göster
        playerBar.style.display = "flex";

        // Kaynağı ata ve oynat
        audio.src = url;
        audio.play().catch(e => console.error("Oynatma hatası:", e));
    }

    function closePlayer() {
        var playerBar = document.getElementById("musicPlayerBar");
        var audio = document.getElementById("globalAudioPlayer");
        audio.pause();
        playerBar.style.display = "none";
    }
</script>
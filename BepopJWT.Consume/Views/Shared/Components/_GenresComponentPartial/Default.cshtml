
@model List<ResultSongWithArtists>

@{
    var userToken = Context.User.FindFirst("AccessToken")?.Value;
}

<div id="main" class="layout-row flex">
    <div id="content" class="flex ">
        <div>
            <div class="page-content page-container" id="page-content">
                <div class="padding sr" id="list" data-plugin="list">
                    <div class="pos-rlt">

                        <div class="py-5">
                            <div class="heading pt-5 pb-3 d-flex ">
                                <div>
                                    <div class="text-muted sr-item">Kütüphane</div>
                                    <h5 class="text-highlight sr-item">Filtrele</h5>
                                </div>
                                <span class="flex"></span>
                            </div>

                            @await Component.InvokeAsync("_GenresCategoryComponentPartial")
                        </div>

                        <div class="row row-lg list">

                            @if (Model != null && Model.Any())
                            {
                                foreach (var item in Model)
                                {
                                    <div class="col-6 col-sm-4 col-md-3 col-lg-2" data-id="@item.SongId">
                                        <div class="list-item list-hover r mb-5">
                                            <div class="media">
                                                <a href="javascript:void(0);" class="ajax media-content"
                                                   style="background-image:url('@item.ImageUrl')"></a>

                                                <div class="media-action media-action-overlay">
                                                    <button class="btn btn-icon no-bg no-shadow hide-row" data-toggle-class>
                                                        <i data-feather="heart" class="active-fill"></i>
                                                    </button>

                                                    <button class="btn btn-raised btn-icon btn-rounded bg--white btn-play"
                                                            onclick="checkSongAccess(event, @item.SongId, '@item.FileUrl')">
                                                    </button>

                                                    <button class="btn btn-icon no-bg no-shadow hide-row btn-more" data-toggle="dropdown">
                                                        <i data-feather="more-horizontal"></i>
                                                    </button>
                                                    <div class="dropdown-menu dropdown-menu-right">
                                                        <a class="dropdown-item" href="#">Listeye Ekle</a>
                                                        <a class="dropdown-item" href="#">İndir</a>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="list-content text-center">
                                                <div class="list-body">
                                                    <a href="javascript:void(0);" class="list-title title ajax h-1x">
                                                        @item.SongTitle
                                                    </a>
                                                    <a href="javascript:void(0);" class="list-subtitle d-block text-muted h-1x subtitle ajax">
                                                        @item.Name
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col-12 text-center p-5">
                                    <h5 class="text-muted">Bu kategoride şarkı bulunamadı.</h5>
                                </div>
                            }

                        </div>

                        <div class="no-result hide">
                            <div class="p-5 text-center">
                                <h5>Sonuç Bulunamadı</h5>
                                <small>Başka bir kategori deneyin.</small>
                            </div>
                        </div>

                        <div class="d-flex py-3 justify-content-center">
                            <ul class="pagination pagination-sm"></ul>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="globalAudioPlayer" style="display: none;" controls>
    <source id="audioSource" src="" type="audio/mpeg">
</audio>
<input type="hidden" id="userToken" value="@userToken" />

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
 
    function checkSongAccess(e, songId, songUrl) {
        if(e) e.preventDefault();
        var token = document.getElementById("userToken").value;

        if (!token) {
            Swal.fire({
                icon: 'error',
                title: 'Oturum Bulunamadı',
                text: 'Müzik dinlemek için lütfen giriş yapın.',
                background: '#1e1e2d',
                color: '#fff'
            });
            return;
        }

        fetch(`https://localhost:7209/api/Songs/check-access/${songId}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.status === 401) {
                Swal.fire({icon: 'error', title: 'Yetkisiz Erişim', text: 'Oturum süreniz dolmuş.'});
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return;

            if (data.isSuccess) {
                playMusic(songUrl);
                const Toast = Swal.mixin({
                  toast: true,
                  position: 'bottom-end',
                  showConfirmButton: false,
                  timer: 3000,
                  timerProgressBar: true,
                  background: '#1e1e2d',
                  color: '#fff'
                });
                Toast.fire({ icon: 'success', title: 'Çalıyor 🎵' });
            } else {
                Swal.fire({
                    title: 'Premium Gerekli',
                    text: data.message,
                    icon: 'warning',
                    confirmButtonText: 'Paketlere Git',
                    confirmButtonColor: '#a855f7',
                    background: '#1e1e2d',
                    color: '#fff'
                }).then((res) => {
                    if (res.isConfirmed) window.location.href = "/Packages/Index";
                });
            }
        })
        .catch(err => console.error("Hata:", err));
    }

    function playMusic(url) {
        var player = document.getElementById("globalAudioPlayer");
        player.src = url;
        player.style.display = "block";
        player.style.width = "100%";
        player.style.position = "fixed";
        player.style.bottom = "0";
        player.style.left = "0";
        player.style.zIndex = "9999";
        player.play().catch(e => console.error(e));
    }
</script>
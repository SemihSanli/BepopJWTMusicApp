@using BepopJWT.Consume.PlaylistDTOs
@using System.Security.Claims
@model ResultPlaylistWithSongsDTO

@{
    ViewData["Title"] = (Model?.PlaylistName ?? "Liste") + " - Detay";
   
    var accessToken = User.FindFirst("AccessToken")?.Value;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
   
    body {
        margin-bottom: 120px;
    }

    .playlist-page {
        background: linear-gradient(to bottom, #2a1b3d 0%, #121212 400px, #121212 100%);
        min-height: 100vh;
        color: white;
    }

    .playlist-header {
        display: flex;
        align-items: flex-end;
        padding: 60px 32px 24px;
        gap: 24px;
    }

    .playlist-cover-art {
        width: 232px;
        height: 232px;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 4px 60px rgba(0,0,0,.5);
    }

    .song-row {
        cursor: pointer;
        transition: background-color 0.2s;
        border-radius: 4px;
    }

        .song-row:hover {
            background: rgba(255,255,255,0.1);
        }

    /* MODAL & PLAYER CSS (Aynen korundu) */
    .modal-content {
        background-color: #282828;
        color: white;
        border: 1px solid #333;
    }

    .modal-header {
        border-bottom: 1px solid #3e3e3e;
    }

    .close {
        color: white;
        text-shadow: none;
        opacity: 1;
    }

    .song-item-add {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #3e3e3e;
    }

        .song-item-add:last-child {
            border-bottom: none;
        }

    .player-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 90px;
        background: #181818;
        border-top: 1px solid #282828;
        display: flex;
        align-items: center;
        padding: 0 16px;
        z-index: 10000;
        color: white;
    }

    .player-left {
        width: 30%;
        display: flex;
        align-items: center;
        gap: 15px;
    }

        .player-left img {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 4px;
        }

    .player-center {
        width: 40%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .controls {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 5px;
    }

        .controls button {
            background: none;
            border: none;
            color: #b3b3b3;
            cursor: pointer;
            transition: 0.2s;
            padding: 0;
        }

            .controls button:hover {
                color: white;
                transform: scale(1.1);
            }

    .btn-main {
        font-size: 32px !important;
        color: white !important;
    }

    .btn-side {
        font-size: 20px !important;
    }

    .progress-container {
        width: 100%;
        height: 4px;
        background: #4d4d4d;
        cursor: pointer;
        border-radius: 2px;
        position: relative;
    }

    .progress {
        height: 100%;
        width: 0%;
        background: #1db954;
        border-radius: 2px;
    }

        .progress:hover {
            background: #1ed760;
        }

    .table td, .table th {
        vertical-align: middle;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .table thead th {
        border-bottom: 1px solid rgba(255,255,255,0.1);
        border-top: none;
    }
</style>

<div class="playlist-page">
    @if (Model != null)
    {
        <div class="playlist-header">
            <img src="@(Model.Songs?.FirstOrDefault()?.ImageUrl ?? "/img/default.png")" class="playlist-cover-art" />
            <div>
                <p class="small text-uppercase font-weight-bold mb-1">Çalma Listesi</p>
                <h1 class="display-4 font-weight-bold mb-3">@Model.PlaylistName</h1>
                <p class="text-white-50 font-weight-bold mb-0">@Model.Username • @(Model.Songs?.Count ?? 0) şarkı</p>
            </div>
        </div>

        <div class="px-4 pb-5">
            <div class="mb-4">
                <button class="btn btn-success btn-rounded px-4 py-2 font-weight-bold" onclick="openAddSongModal()">
                    <i class="fa fa-plus mr-2"></i> Şarkı Ekle
                </button>
            </div>

            <table class="table table-borderless table-hover text-white">
                <thead>
                    <tr class="text-muted small border-bottom">
                        <th style="width: 50px;">#</th>
                        <th>BAŞLIK</th>
                        <th>SANATÇI</th>
                        <th class="text-right"><i class="fa fa-clock-o"></i></th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int i = 1;
                        if (Model.Songs != null)
                        {
                            foreach (var song in Model.Songs)
                            {
                                <tr class="song-row" onclick="selectSong(@song.SongId, '@song.FileUrl','@song.SongTitle','@song.ArtistName','@song.ImageUrl')">
                                    <td class="text-center text-muted">@i</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="@song.ImageUrl" width="40" height="40" class="rounded mr-3 shadow-sm" style="object-fit: cover;" />
                                            <span class="font-weight-bold text-white">@song.SongTitle</span>
                                        </div>
                                    </td>
                                    <td class="text-white-50">@song.ArtistName</td>
                                    <td class="text-right" onclick="event.stopPropagation()">
                                        <button class="btn btn-sm btn-link text-white-50 hover-white" onclick="removeSong(@Model.PlaylistId, @song.SongId)" title="Listeden Kaldır">
                                            <i class="fa fa-trash fa-lg"></i>
                                        </button>
                                    </td>
                                </tr>
                                i++;
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="d-flex align-items-center justify-content-center" style="height: 50vh;">
            <div class="text-center">
                <h3 class="text-white">Çalma listesi bulunamadı.</h3>
                <a href="/Playlist/Index" class="btn btn-outline-light mt-3">Listelere Dön</a>
            </div>
        </div>
    }
</div>

<div class="modal fade" id="addSongModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-weight-bold">Şarkı Seçin</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;" id="allSongsList">
                <div class="text-center py-5"><i class="fa fa-circle-o-notch fa-spin fa-3x text-success"></i></div>
            </div>
        </div>
    </div>
</div>

<div class="player-bar">
    <div class="player-left">
        <img id="cover" src="/img/default.png" class="shadow-sm" />
        <div>
            <div id="title" class="font-weight-bold" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">Seçim Yok</div>
            <div id="artist" class="small text-white-50">...</div>
        </div>
    </div>
    <div class="player-center">
        <div class="controls">
            <button class="btn-side" onclick="playPrev()"><i class="fa fa-step-backward"></i></button>
            <button class="btn-main" onclick="togglePlay()"><i id="playIcon" class="fa fa-play-circle"></i></button>
            <button class="btn-side" onclick="playNext()"><i class="fa fa-step-forward"></i></button>
        </div>
        <div class="d-flex align-items-center w-100 gap-2">
            <span id="currentTime" class="small text-white-50 mr-2">0:00</span>
            <div class="progress-container" onclick="seek(event)"><div id="progress" class="progress"></div></div>
            <span id="duration" class="small text-white-50 ml-2">0:00</span>
        </div>
    </div>
    <div style="width: 30%; display: flex; justify-content: flex-end; padding-right: 20px;">
        <i class="fa fa-volume-up text-white-50"></i>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const token = "@accessToken";
    const currentPlaylistId = @(Model?.PlaylistId ?? 0);

    let audio = new Audio();
    let isPlaying = false;
    let currentSongIndex = -1;
    let audioBlobUrl = null;

   
    const songList = [
    @if (Model?.Songs != null)
    {
        foreach (var song in Model.Songs)
        {
            <text>{ id: @song.SongId, url: '@song.FileUrl', title: '@song.SongTitle', artist: '@song.ArtistName', image: '@song.ImageUrl' },</text>
        }
    }
    ];

    const playIcon = document.getElementById("playIcon");
    const progress = document.getElementById("progress");

 

    function selectSong(id, url, title, artist, image) {
     
        currentSongIndex = songList.findIndex(s => s.id === id);

     
        updatePlayerUI(title, artist, image);

       
        checkAccessAndPlay(id, url);
    }

   
    async function checkAccessAndPlay(songId, songUrl) {
        
        if (!token) {
            Swal.fire({icon: 'error', title: 'Giriş Yapın', text: 'Müzik dinlemek için oturum açmalısınız.', background: '#282828', color: 'white'});
            return;
        }

      
        playIcon.className = "fa fa-spinner fa-spin";

        try {
           
            const response = await fetch(`https://localhost:7209/api/Songs/check-access/${songId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (response.status === 401) {
                playIcon.className = "fa fa-play-circle";
                Swal.fire({icon: 'error', title: 'Oturum Doldu', text: 'Lütfen tekrar giriş yapın.', background: '#282828', color: 'white'});
                return;
            }

            const data = await response.json();

            if (data && data.isSuccess) {
              
                playWithAuth(songUrl);
            } else {
                
                playIcon.className = "fa fa-play-circle";
                Swal.fire({
                    title: 'Erişim Engellendi',
                    text: data.message || 'Bu içeriği görüntülemek için Premium üye olmalısınız.',
                    icon: 'warning',
                    confirmButtonText: 'Paketlere Git',
                    confirmButtonColor: '#1db954',
                    background: '#282828',
                    color: 'white'
                }).then((res) => {
                    if (res.isConfirmed) window.location.href = "/Packages/Index";
                });
            }

        } catch (err) {
            console.error(err);
            playIcon.className = "fa fa-play-circle";
        }
    }

  
    async function playWithAuth(url) {
        if (audioBlobUrl) {
            URL.revokeObjectURL(audioBlobUrl);
        }

        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (response.ok) {
                const blob = await response.blob();
                audioBlobUrl = URL.createObjectURL(blob);
                audio.src = audioBlobUrl;

                audio.play().then(() => {
                    isPlaying = true;
                    playIcon.className = "fa fa-pause-circle";

                 
                    const Toast = Swal.mixin({
                        toast: true, position: 'bottom-end', showConfirmButton: false, timer: 3000,
                        background: '#282828', color: 'white'
                    });
                    Toast.fire({ icon: 'success', title: 'Çalıyor 🎵' });

                }).catch(e => console.error(e));
            } else {
                console.error("Dosya çekilemedi status:", response.status);
            }
        } catch (error) {
            console.error("Blob hatası:", error);
        }
    }

   

    function updatePlayerUI(title, artist, image) {
        document.getElementById("title").innerText = title;
        document.getElementById("artist").innerText = artist;
        document.getElementById("cover").src = image;
    }

    function togglePlay() {
        if (!audio.src && songList.length > 0) {
           
             playAtIndex(0);
             return;
        }
        if(!audio.src) return;

        if(isPlaying) {
             audio.pause();
             isPlaying = false;
             playIcon.className = "fa fa-play-circle";
        } else {
             audio.play();
             isPlaying = true;
             playIcon.className = "fa fa-pause-circle";
        }
    }

    function playNext() {
        if (songList.length === 0) return;
        let nextIndex = (currentSongIndex + 1) % songList.length;
        playAtIndex(nextIndex);
    }

    function playPrev() {
        if (songList.length === 0) return;
        let prevIndex = (currentSongIndex - 1 + songList.length) % songList.length;
        playAtIndex(prevIndex);
    }

    function playAtIndex(index) {
        const song = songList[index];
      
        selectSong(song.id, song.url, song.title, song.artist, song.image);
    }

  
    audio.ontimeupdate = () => {
        if (!audio.duration) return;
        const percent = (audio.currentTime / audio.duration) * 100;
        progress.style.width = percent + "%";
        document.getElementById("currentTime").innerText = formatTime(audio.currentTime);
        document.getElementById("duration").innerText = formatTime(audio.duration);
    };

    audio.onended = () => playNext();

    function formatTime(s) {
        if (isNaN(s)) return "0:00";
        const m = Math.floor(s / 60);
        const sc = Math.floor(s % 60);
        return m + ":" + (sc < 10 ? "0" + sc : sc);
    }

    function seek(e) {
        if (!audio.duration) return;
        const w = e.currentTarget.clientWidth;
        audio.currentTime = (e.offsetX / w) * audio.duration;
    }

   
    function removeSong(pId, sId) {
        Swal.fire({
            title: 'Emin misiniz?', text: "Şarkı listeden kaldırılacak.", icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet', cancelButtonText: 'Hayır', background: '#282828', color: 'white'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: 'https://localhost:7209/api/Playlists/RemoveSong',
                    type: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token },
                    data: { playlistId: pId, songId: sId },
                    success: function() {
                        location.reload();
                    },
                    error: function() { Swal.fire({icon:'error', title:'Hata', background:'#282828', color:'white'}); }
                });
            }
        });
    }

    function openAddSongModal() {
        $('#addSongModal').modal('show');
        $.ajax({
            url: 'https://localhost:7209/api/Songs',
            type: 'GET',
            headers: { 'Authorization': 'Bearer ' + token },
            success: function(songs) {
                let html = '';
                if(songs.length === 0) html = '<div class="p-4 text-center">Şarkı yok.</div>';
                else {
                    songs.forEach(s => {
                        html += `<div class="song-item-add">
                                    <div class="d-flex align-items-center">
                                        <img src="${s.imageUrl}" width="40" height="40" class="rounded mr-2">
                                        <div><div class="font-weight-bold">${s.songTitle}</div><div class="small text-muted">${s.artistName}</div></div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-success" onclick="addSongToPlaylist(${s.songId})">Ekle</button>
                                 </div>`;
                    });
                }
                $('#allSongsList').html(html);
            }
        });
    }

    function addSongToPlaylist(songId) {
        $.ajax({
            url: 'https://localhost:7209/api/Playlists/add-song',
            type: 'POST',
            contentType: 'application/json',
            headers: { 'Authorization': 'Bearer ' + token },
            data: JSON.stringify({ playlistId: currentPlaylistId, songId: songId }),
            success: function() {
                Swal.fire({icon:'success', title:'Eklendi', toast:true, position:'top-end', showConfirmButton:false, timer:1500, background:'#282828', color:'white'});
                setTimeout(()=> location.reload(), 1000);
            }
        });
    }
</script>
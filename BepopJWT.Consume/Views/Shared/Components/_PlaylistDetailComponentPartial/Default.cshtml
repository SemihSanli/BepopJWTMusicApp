@using BepopJWT.Consume.PlaylistDTOs
@model ResultPlaylistWithSongsDTO

@{
    ViewData["Title"] = (Model?.PlaylistName ?? "Liste") + " - Detay";
    Layout = "~/Views/Shared/_MainLayout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
    body {
        margin-bottom: 120px;
    }

    .playlist-page {
        background: linear-gradient(to bottom, #2a1b3d 0%, #121212 400px, #121212 100%);
        min-height: 100vh;
        color: white;
    }

    .playlist-header {
        display: flex;
        align-items: flex-end;
        padding: 60px 32px 24px;
        gap: 24px;
    }

    .playlist-cover-art {
        width: 232px;
        height: 232px;
        object-fit: cover;
        border-radius: 4px;
    }

    .song-row {
        cursor: pointer;
    }

        .song-row:hover {
            background: rgba(255,255,255,0.1);
        }

    /* MODAL STYLES (Ekledik) */
    .modal-content {
        background-color: #181818;
        color: white;
        border: 1px solid #333;
    }

    .modal-header {
        border-bottom: 1px solid #333;
    }

    .song-item-add {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #222;
    }

    /* ==== PLAYER BAR (Senin Tasarımın) ==== */
    .player-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 110px;
        background: #181818;
        border-top: 2px solid #a855f7;
        display: flex;
        align-items: center;
        padding: 0 30px;
        z-index: 10000;
        color: white;
    }

    .player-left {
        width: 30%;
        display: flex;
        align-items: center;
        gap: 15px;
    }

        .player-left img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #333;
        }

    .player-center {
        width: 40%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 30px;
        margin-bottom: 8px;
    }

        .controls button {
            background: none;
            border: none;
            color: white !important;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 5px;
            outline: none;
        }

            .controls button:hover {
                transform: scale(1.2);
                color: #a855f7 !important;
            }

    .btn-main {
        font-size: 50px !important;
    }

    .btn-side {
        font-size: 28px !important;
        color: #b3b3b3 !important;
    }

    .progress-container {
        width: 100%;
        height: 6px;
        background: #444;
        cursor: pointer;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress {
        height: 100%;
        width: 0%;
        background: #a855f7;
    }
</style>

<div class="playlist-page">
    @if (Model != null)
    {
        <div class="playlist-header">
            <img src="@(Model.Songs?.FirstOrDefault()?.ImageUrl ?? "/img/default.png")" class="playlist-cover-art" />
            <div>
                <p class="small text-uppercase font-weight-bold">Çalma Listesi</p>
                <h1 style="font-size: 4.5rem; font-weight: 900; letter-spacing: -2px;">@Model.PlaylistName</h1>
                <p class="text-muted font-weight-bold">@Model.Username • @(Model.Songs?.Count ?? 0) şarkı</p>
            </div>
        </div>

        <div class="px-4">
            <div class="mb-4">
                <button class="btn btn-primary btn-rounded px-4" onclick="openAddSongModal()">
                    <i class="fa fa-plus mr-2"></i> Kütüphaneden Şarkı Ekle
                </button>
            </div>

            <table class="table table-dark table-hover bg-transparent">
                <thead>
                    <tr class="text-muted small">
                        <th>#</th>
                        <th>BAŞLIK</th>
                        <th>SANATÇI</th>
                        <th class="text-right">İŞLEM</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int i = 1;
                        foreach (var song in Model.Songs)
                        {
                            <tr class="song-row" onclick="selectSong('@song.FileUrl','@song.SongTitle','@song.ArtistName','@song.ImageUrl')">
                                <td style="width: 50px;">@i</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="@song.ImageUrl" width="40" height="40" class="rounded mr-3" style="object-fit: cover;" />
                                        <span class="font-weight-bold">@song.SongTitle</span>
                                    </div>
                                </td>
                                <td class="text-muted">@song.ArtistName</td>
                                <td class="text-right" onclick="event.stopPropagation()">
                                    <button class="btn btn-link text-danger" onclick="removeSong(@Model.PlaylistId, @song.SongId)">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            i++;
                        }
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<div class="modal fade" id="addSongModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-weight-bold">Kütüphaneden Şarkı Ekle</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto;" id="allSongsList">
                <div class="text-center py-5"><i class="fa fa-spinner fa-spin fa-2x"></i></div>
            </div>
        </div>
    </div>
</div>

<div class="player-bar">
    <div class="player-left">
        <img id="cover" src="/img/default.png" />
        <div style="overflow: hidden;">
            <div id="title" class="font-weight-bold" style="white-space: nowrap; text-overflow: ellipsis;">Şarkı Seçilmedi</div>
            <div id="artist" class="text-muted small">Sanatçı</div>
        </div>
    </div>

    <div class="player-center">
        <div class="controls">
            <button class="btn-side" onclick="playPrev()" title="Önceki"><i class="fa fa-step-backward"></i></button>
            <button class="btn-main" onclick="togglePlay()" title="Oynat/Durdur"><i id="playIcon" class="fa fa-play-circle"></i></button>
            <button class="btn-side" onclick="playNext()" title="Sonraki"><i class="fa fa-step-forward"></i></button>
        </div>
        <div class="progress-container" onclick="seek(event)"><div id="progress" class="progress"></div></div>
        <div class="d-flex justify-content-between mt-1 w-100" style="font-size: 12px; color: #b3b3b3;">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
        </div>
    </div>

    <div style="width: 30%; display: flex; justify-content: flex-end; padding-right: 20px;">
        <i class="fa fa-volume-up" style="font-size: 20px; color: #b3b3b3;"></i>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function() {
        $('.loader, #preloader, .preloader').fadeOut('fast');
        $('body').css({'overflow':'auto', 'height':'auto'});
    });

    const token = localStorage.getItem("AccessToken") || "";
    const currentPlaylistId = @(Model?.PlaylistId ?? 0);
    let audio = new Audio();
    let isPlaying = false;
    let currentSongIndex = -1;

    const songList = [
    @if (Model?.Songs != null)
    {
        foreach (var song in Model.Songs)
        {
            <text>{ url: '@song.FileUrl', title: '@song.SongTitle', artist: '@song.ArtistName', image: '@song.ImageUrl' },</text>
        }
    }
    ];

    // --- YENİ: ŞARKI YÖNETİM FONKSİYONLARI ---

    function openAddSongModal() {
        $('#addSongModal').modal('show');
        $.ajax({
            url: 'https://localhost:7209/api/Songs', // Tüm şarkıları çektiğimiz API
            type: 'GET',
            headers: { 'Authorization': 'Bearer ' + token },
            success: function(songs) {
                let html = '';
                songs.forEach(s => {
                    html += `
                    <div class="song-item-add">
                        <div class="d-flex align-items-center">
                            <img src="${s.imageUrl}" width="45" height="45" class="rounded mr-3" style="object-fit:cover;">
                            <div>
                                <div class="font-weight-bold">${s.songTitle}</div>
                                <div class="small text-muted">${s.artistName}</div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary px-3" onclick="addSongToPlaylist(${s.songId})">
                            <i class="fa fa-plus"></i> Ekle
                        </button>
                    </div>`;
                });
                $('#allSongsList').html(html);
            }
        });
    }

    function addSongToPlaylist(songId) {
        $.ajax({
            url: 'https://localhost:7209/api/Playlists/add-song', // Ekleme endpointi
            type: 'POST',
            contentType: 'application/json',
            headers: { 'Authorization': 'Bearer ' + token },
            data: JSON.stringify({ playlistId: currentPlaylistId, songId: songId }),
            success: function() {
                Swal.fire({ icon: 'success', title: 'Şarkı Eklendi', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                location.reload();
            },
            error: function() { Swal.fire('Hata', 'Bu şarkı zaten ekli veya bir sorun oluştu.', 'error'); }
        });
    }

    function removeSong(pId, sId) {
        Swal.fire({
            title: 'Emin misiniz?',
            text: "Şarkı çalma listesinden çıkarılacak.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Evet, Sil'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `https://localhost:7209/api/Playlists/RemoveSong?playlistId=${pId}&songId=${sId}`,
                    type: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token },
                    success: function() { location.reload(); }
                });
            }
        });
    }

    // --- SENİN PLAYER FONKSİYONLARIN (Dokunmadık) ---

    const playIcon = document.getElementById("playIcon");
    const progress = document.getElementById("progress");

    function selectSong(url, title, artist, image) {
        currentSongIndex = songList.findIndex(s => s.url === url);
        if (audio.src !== url) { audio.src = url; audio.currentTime = 0; }
        playAudio();
        document.getElementById("title").innerText = title;
        document.getElementById("artist").innerText = artist;
        document.getElementById("cover").src = image;
    }

    function togglePlay() {
        if (!audio.src) { if(songList.length > 0) playAtIndex(0); return; }
        isPlaying ? pauseAudio() : playAudio();
    }

    function playAudio() {
        audio.play().then(() => { isPlaying = true; playIcon.className = "fa fa-pause-circle"; }).catch(err => console.log(err));
    }

    function pauseAudio() { audio.pause(); isPlaying = false; playIcon.className = "fa fa-play-circle"; }

    function playNext() {
        if (currentSongIndex < songList.length - 1) playAtIndex(currentSongIndex + 1);
        else playAtIndex(0);
    }

    function playPrev() {
        if (currentSongIndex > 0) playAtIndex(currentSongIndex - 1);
        else playAtIndex(songList.length - 1);
    }

    function playAtIndex(index) {
        const song = songList[index];
        selectSong(song.url, song.title, song.artist, song.image);
    }

    audio.ontimeupdate = () => {
        if (!audio.duration) return;
        const percent = (audio.currentTime / audio.duration) * 100;
        progress.style.width = percent + "%";
        document.getElementById("currentTime").innerText = formatTime(audio.currentTime);
        document.getElementById("duration").innerText = formatTime(audio.duration);
    };

    audio.onended = () => { playNext(); };

    function formatTime(seconds) {
        if (isNaN(seconds)) return "0:00";
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return min + ":" + (sec < 10 ? "0" + sec : sec);
    }

    function seek(e) {
        if (!audio.duration) return;
        const width = e.currentTarget.clientWidth;
        audio.currentTime = (e.offsetX / width) * audio.duration;
    }
</script>